id: api-to-s3
namespace: enygea.dlt

tasks:
  - id: dlt_pipeline
    type: io.kestra.plugin.core.flow.WorkingDirectory
    tasks:
    - id: clone_repo
      type: io.kestra.plugin.git.Clone
      url: https://github.com/bbouretdev/enygea_poc_dlt.git
      branch: main
  
    - id: run_pipeline
      type: io.kestra.plugin.scripts.python.Script
      taskRunner:
        type: io.kestra.plugin.scripts.runner.docker.Docker
      containerImage: python:3.11-slim
      beforeCommands:
        - pip install --upgrade pip
        - pip install "dlt[filesystem,s3]"
      env:
        AWS_ACCESS_KEY_ID: "SCWQCVXV924JWRBFPNZJ"
        AWS_SECRET_ACCESS_KEY: "770cac14-4c32-4af5-9f1f-46442d3bf171"
        AWS_DEFAULT_REGION: "fr-par"
        DESTINATION__FILESYSTEM__BUCKET_URL: "s3://sandbox-datalake-bronze/dlt"
        DESTINATION__FILESYSTEM__ENDPOINT_URL: "https://s3.fr-par.scw.cloud"
        AWS_S3_FORCE_PATH_STYLE: "true"
      script: |
        import subprocess
        subprocess.run(["python", "pipelines/api/pokeapi/get_all_pokemons.py"], check=True)